<!doctype html>
<html lang="zh-CN">
  <head>
    <title>Chanel底层原理 // 张海余的主页</title>
    <link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/35171365?s=400&amp;u=4028845ffbfa05c281117eee69a561e7e4e268ad&amp;v=4" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.92.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="张海余" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.4e1ed185f0488299cad4146a639371a20f6acead17adf3b7069862be9228ef05.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Chanel底层原理"/>
<meta name="twitter:description" content="数据结构
type hchan struct { qcount uint // 循环队列中的元素数量 	dataqsiz uint // 循环队列的长度 	buf unsafe.Pointer // 指向循环队列（循环数组）的指针，只针对有缓冲的channel 	elemsize uint16 // 元素大小 	closed uint32 // channel是否关闭的标志 	elemtype *_type // 元素类型 	sendx uint // 记录循环队列中发送操作处理到的位置（索引） 	recvx uint // 记录循环队列中接收操作处理到的位置（索引） 	recvq waitq // 存储了当前channel读阻塞的goroutine列表（双向链表） 	sendq waitq // 存储了当前channel写阻塞的goroutine列表（双向链表） 	lock mutex // 互斥所，保护channel中所有字段，还有一些阻塞在当前channel上sudogs中的一些字段 } type waitq struct { first *sudog // 指向双向链表第一个节点 	last *sudog // 指向双向链表最后一个节点 } // sudog代表一个在等待队列中的goroutine type sudog struct { g *g next *sudog // 双向链表后指针 	prev *sudog // 双向链表前指针 	elem unsafe."/>

    <meta property="og:title" content="Chanel底层原理" />
<meta property="og:description" content="数据结构
type hchan struct { qcount uint // 循环队列中的元素数量 	dataqsiz uint // 循环队列的长度 	buf unsafe.Pointer // 指向循环队列（循环数组）的指针，只针对有缓冲的channel 	elemsize uint16 // 元素大小 	closed uint32 // channel是否关闭的标志 	elemtype *_type // 元素类型 	sendx uint // 记录循环队列中发送操作处理到的位置（索引） 	recvx uint // 记录循环队列中接收操作处理到的位置（索引） 	recvq waitq // 存储了当前channel读阻塞的goroutine列表（双向链表） 	sendq waitq // 存储了当前channel写阻塞的goroutine列表（双向链表） 	lock mutex // 互斥所，保护channel中所有字段，还有一些阻塞在当前channel上sudogs中的一些字段 } type waitq struct { first *sudog // 指向双向链表第一个节点 	last *sudog // 指向双向链表最后一个节点 } // sudog代表一个在等待队列中的goroutine type sudog struct { g *g next *sudog // 双向链表后指针 	prev *sudog // 双向链表前指针 	elem unsafe." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fishwin.github.io/golang/chanel%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" /><meta property="article:section" content="golang" />
<meta property="article:published_time" content="2022-11-24T17:07:48+08:00" />
<meta property="article:modified_time" content="2022-11-24T17:07:48+08:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://fishwin.github.io/"><img class="app-header-avatar" src="https://avatars.githubusercontent.com/u/35171365?s=400&amp;u=4028845ffbfa05c281117eee69a561e7e4e268ad&amp;v=4" alt="张海余" /></a>
      <span class="app-header-title">张海余的主页</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">首页</a>
            --
          
          <a class="app-header-menu-item" href="/golang/">Go</a>
            --
          
          <a class="app-header-menu-item" href="/os/">操作系统</a>
            --
          
          <a class="app-header-menu-item" href="/net/">网络协议</a>
            --
          
          <a class="app-header-menu-item" href="/distribution/">分布式</a>
            --
          
          <a class="app-header-menu-item" href="/sysdesign/">系统设计</a>
            --
          
          <a class="app-header-menu-item" href="/algorithm/">算法</a>
            --
          
          <a class="app-header-menu-item" href="/db/">数据库</a>
            --
          
          <a class="app-header-menu-item" href="/middleware/">中间件</a>
            --
          
          <a class="app-header-menu-item" href="/othertech/">谈古论今</a>
            --
          
          <a class="app-header-menu-item" href="/about/">关于</a>
      </nav>
      <p>张海余的个人博客，好记性不如烂笔头，互联网老兵</p>
      <div class="app-header-social">
        
          <a href="https://github.com/fishwin" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>My Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Chanel底层原理</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Nov 24, 2022
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          1 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <ul>
<li>
<p>数据结构</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">hchan</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">qcount</span>   <span style="color:#66d9ef">uint</span>           <span style="color:#75715e">// 循环队列中的元素数量
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dataqsiz</span> <span style="color:#66d9ef">uint</span>           <span style="color:#75715e">// 循环队列的长度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">buf</span>      <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> <span style="color:#75715e">// 指向循环队列（循环数组）的指针，只针对有缓冲的channel
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">elemsize</span> <span style="color:#66d9ef">uint16</span>     <span style="color:#75715e">// 元素大小
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">closed</span>   <span style="color:#66d9ef">uint32</span>       <span style="color:#75715e">// channel是否关闭的标志
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">elemtype</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">_type</span> <span style="color:#75715e">// 元素类型
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sendx</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// 记录循环队列中发送操作处理到的位置（索引）
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">recvx</span>    <span style="color:#66d9ef">uint</span>   <span style="color:#75715e">// 记录循环队列中接收操作处理到的位置（索引）
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">recvq</span>    <span style="color:#a6e22e">waitq</span>  <span style="color:#75715e">// 存储了当前channel读阻塞的goroutine列表（双向链表）
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sendq</span>    <span style="color:#a6e22e">waitq</span>  <span style="color:#75715e">// 存储了当前channel写阻塞的goroutine列表（双向链表）
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">mutex</span>  <span style="color:#75715e">// 互斥所，保护channel中所有字段，还有一些阻塞在当前channel上sudogs中的一些字段
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">waitq</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">first</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span>  <span style="color:#75715e">// 指向双向链表第一个节点
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">last</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span> <span style="color:#75715e">// 指向双向链表最后一个节点
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//  sudog代表一个在等待队列中的goroutine
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">sudog</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">g</span>

	<span style="color:#a6e22e">next</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span>  <span style="color:#75715e">// 双向链表后指针
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">prev</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span> <span style="color:#75715e">// 双向链表前指针
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">elem</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span> <span style="color:#75715e">// data element (may point to stack)
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">acquiretime</span> <span style="color:#66d9ef">int64</span>
	<span style="color:#a6e22e">releasetime</span> <span style="color:#66d9ef">int64</span>
	<span style="color:#a6e22e">ticket</span>      <span style="color:#66d9ef">uint32</span>

	<span style="color:#a6e22e">isSelect</span> <span style="color:#66d9ef">bool</span>

	<span style="color:#a6e22e">parent</span>   <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span> <span style="color:#75715e">// semaRoot binary tree
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">waitlink</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span> <span style="color:#75715e">// g.waiting list or semaRoot
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">waittail</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span> <span style="color:#75715e">// semaRoot
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">hchan</span> <span style="color:#75715e">// channel
</span><span style="color:#75715e"></span>}
</code></pre></div><p>循环队列（数组）+ 双向链表（读阻塞）+双向链表（写阻塞）</p>
</li>
<li>
<p>为什么channel是引用类型</p>
<p>在编译阶段，make(chan int, 10)中的make函数会被转换为runtime.makechan或runtime.makechan64函数，同时，返回一个hchan结构体的指针。</p>
</li>
<li>
<p>写channel或者读channel为什么是线程安全的</p>
<p>在写channel或读channel时，都会使用hchan结构体中的lock进行并发控制（加锁）</p>
</li>
<li>
<p>写channel过程</p>
<ol>
<li>首先使用hchan.lock对结构体加锁</li>
<li>将数据从goroutine拷贝到hchan.buf即循环队列中</li>
<li>释放锁</li>
</ol>
</li>
<li>
<p>读channel过程</p>
<ol>
<li>首先使用hchan.lock对结构体加锁</li>
<li>将数据hchan.buf中的头元素，拷贝到goroutine中</li>
<li>释放锁</li>
</ol>
</li>
<li>
<p>G1写一个缓冲区为3的channel过程中，缓冲区被写满之后，再次写入发生了什么</p>
<ol>
<li>channel调用go调度器(gopark函数)，让G1等待，并且G1让出M，让其他goroutine运行。</li>
<li>同时G1会被抽象为sudog结构体保存到channel中的sendq队列中，等待被唤醒</li>
<li>当有其他goroutine读channel时，这时channel就会将sendq中的G1推出，调用go调度器（goready函数），将G1放入到P的运行队列中，等待被调度运行。</li>
</ol>
</li>
<li>
<p>G2读一个缓冲区为3的channel时，缓冲区无数据，是如何进入阻塞和被唤醒的</p>
<ol>
<li>当G2读取channel时，发现channel中无数据，channel会调用go调度器(gopark函数)，使G2等待，G2让出M，让其他goroutine运行</li>
<li>同时G2会被抽象为sudog结构体并保存在channel中的recvq队列中，等待被唤醒</li>
<li>当有其他goroutine向channel写入数据后，此时channel会将G2从recvq中推出G2，并调用go调度器（goready函数），将G2放到P的运行队列中，等待被调度运行。</li>
</ol>
</li>
<li>
<p>注意</p>
<ol>
<li>向已经关闭的channel写入数据，会panic</li>
<li>关闭已经关闭的channel会panic</li>
<li>range channel时，如果channel不被close，会一直阻塞</li>
</ol>
</li>
<li>
<p>判断channel关闭</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//  一般用法
</span><span style="color:#75715e"></span><span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>
<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;closed 1&#34;</span>)
}

<span style="color:#75715e">// 通过偏移
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">isChanClosed</span>(<span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">cptr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#66d9ef">uintptr</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(
		<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(uintptr(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ch</span>)) <span style="color:#f92672">+</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(uint(<span style="color:#ae81ff">0</span>))),
	))

	<span style="color:#a6e22e">cptr</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(uint(<span style="color:#ae81ff">0</span>))<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>
	<span style="color:#a6e22e">cptr</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(uintptr(<span style="color:#ae81ff">0</span>)))
	<span style="color:#a6e22e">cptr</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(uint16(<span style="color:#ae81ff">0</span>))
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#66d9ef">uint32</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">cptr</span>)) &gt; <span style="color:#ae81ff">0</span>
}
</code></pre></div></li>
</ul>
<p>参考：</p>
<p><a href="https://juejin.im/post/6844903821349502990">https://juejin.im/post/6844903821349502990</a></p>
<p><a href="https://learnku.com/articles/32142">https://learnku.com/articles/32142</a></p>
<p><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/">https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/</a></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
